# Estrategia de Pruebas de Integraci√≥n - Repositorios Separados

**Fecha:** 2025-10-13  
**Versi√≥n:** 1.0  
**Estado:** Propuesta

---

## üìä Situaci√≥n Actual

### Problema Identificado

Despu√©s de la separaci√≥n de repositorios:
- ‚úÖ OSM-Notes-profile tiene tests de integraci√≥n para **Ingestion + WMS**
- ‚úÖ OSM-Notes-Analytics tiene tests de integraci√≥n para **ETL + Datamarts**
- ‚ùå El workflow de OSM-Notes-profile a√∫n referencia tests de ETL/datamart que ya no existen
- ‚ùå No hay tests de integraci√≥n **cross-repository** (Ingestion ‚Üí Analytics)

### Tests Actuales por Repositorio

#### OSM-Notes-profile (`tests/integration/`)
```
‚úÖ end_to_end.test.bats                     # E2E de ingestion
‚úÖ processAPI_historical_e2e.test.bats      # API E2E
‚úÖ processAPINotes_parallel_error_integration.test.bats
‚úÖ boundary_processing_error_integration.test.bats
‚úÖ wms_integration.test.bats                # WMS
‚úÖ xslt_integration.test.bats
‚úÖ mock_planet_processing.test.bats
‚úÖ logging_pattern_validation_integration.test.bats
```
**Total:** 8 tests de integraci√≥n ‚úÖ

#### OSM-Notes-Analytics (`tests/integration/`)
```
‚úÖ ETL_enhanced_integration.test.bats       # ETL
‚úÖ datamart_enhanced_integration.test.bats  # Datamarts
```
**Total:** 2 tests de integraci√≥n ‚úÖ

---

## üéØ Estrategia Propuesta: Tests Independientes por Repositorio

### Principio Fundamental

**Cada repositorio prueba SU funcionalidad de forma independiente**

```
OSM-Notes-profile Tests        OSM-Notes-Analytics Tests
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     ‚îÇ       ‚îÇ                      ‚îÇ
‚îÇ ‚úì Ingesta Planet    ‚îÇ       ‚îÇ ‚úì ETL desde BD       ‚îÇ
‚îÇ ‚úì Ingesta API       ‚îÇ       ‚îÇ ‚úì Datamarts          ‚îÇ
‚îÇ ‚úì WMS               ‚îÇ       ‚îÇ ‚úì Profile generation ‚îÇ
‚îÇ ‚úì Monitoreo         ‚îÇ       ‚îÇ ‚úì Star schema        ‚îÇ
‚îÇ                     ‚îÇ       ‚îÇ                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                              ‚îÇ
         ‚îÇ                              ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Database (shared)   ‚îÇ
         ‚îÇ                      ‚îÇ
         ‚îÇ  ‚Ä¢ public schema     ‚îÇ
         ‚îÇ  ‚Ä¢ wms schema        ‚îÇ
         ‚îÇ  ‚Ä¢ dwh schema        ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìã Tests por Repositorio (Definici√≥n Clara)

### 1. OSM-Notes-profile (Ingestion & WMS)

#### Responsabilidad de Testing
Probar que los datos se **ingresan correctamente** a la base de datos:

**Tests de Integraci√≥n:**
```bash
tests/integration/
‚îú‚îÄ‚îÄ end_to_end.test.bats
‚îÇ   ‚îî‚îÄ‚îÄ Prueba: Planet ‚Üí BD (schema public)
‚îÇ       ‚úì Descarga planet
‚îÇ       ‚úì Procesa XML
‚îÇ       ‚úì Inserta en notes, note_comments
‚îÇ       ‚úì Verifica integridad de datos
‚îÇ
‚îú‚îÄ‚îÄ processAPI_historical_e2e.test.bats
‚îÇ   ‚îî‚îÄ‚îÄ Prueba: API ‚Üí BD (schema public)
‚îÇ       ‚úì Descarga desde API
‚îÇ       ‚úì Sincroniza con BD
‚îÇ       ‚úì Verifica datos actualizados
‚îÇ
‚îú‚îÄ‚îÄ wms_integration.test.bats
‚îÇ   ‚îî‚îÄ‚îÄ Prueba: BD ‚Üí WMS (schema wms)
‚îÇ       ‚úì Triggers funcionan
‚îÇ       ‚úì Datos en wms.notes_wms
‚îÇ       ‚úì Geometr√≠as correctas
‚îÇ
‚îî‚îÄ‚îÄ ...otros tests de ingestion
```

**Contrato de Salida:**
- ‚úÖ Tablas `notes`, `note_comments`, `note_comments_text` pobladas
- ‚úÖ Schema `public` listo para consumo
- ‚úÖ Schema `wms` actualizado via triggers
- ‚úÖ Datos v√°lidos y consistentes

---

### 2. OSM-Notes-Analytics (DWH & Analytics)

#### Responsabilidad de Testing
Probar que los datos se **transforman y analizan correctamente**:

**Tests de Integraci√≥n:**
```bash
tests/integration/
‚îú‚îÄ‚îÄ ETL_enhanced_integration.test.bats
‚îÇ   ‚îî‚îÄ‚îÄ Prueba: BD public ‚Üí BD dwh
‚îÇ       ‚úì Lee de notes, note_comments
‚îÇ       ‚úì Transforma a star schema
‚îÇ       ‚úì Inserta en dwh.facts
‚îÇ       ‚úì Popula dimensiones
‚îÇ       ‚úì Verifica integridad referencial
‚îÇ
‚îî‚îÄ‚îÄ datamart_enhanced_integration.test.bats
    ‚îî‚îÄ‚îÄ Prueba: dwh ‚Üí datamarts
        ‚úì Procesa dwh.facts
        ‚úì Genera datamart_countries
        ‚úì Genera datamart_users
        ‚úì Verifica agregaciones
```

**Contrato de Entrada:**
- ‚úÖ Asume que tablas `notes`, `note_comments` tienen datos v√°lidos
- ‚úÖ No prueba la ingestion (eso es responsabilidad de Profile)

**Contrato de Salida:**
- ‚úÖ Schema `dwh` poblado correctamente
- ‚úÖ Datamarts generados
- ‚úÖ Perfiles disponibles

---

## üîÑ Tests de Integraci√≥n Cross-Repository (OPCIONAL)

### Opci√≥n A: Test en Repositorio Separado (Recomendado)

Crear un **tercer repositorio** para tests end-to-end completos:

```
OSM-Notes-E2E-Tests/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ .github/workflows/
‚îÇ   ‚îî‚îÄ‚îÄ e2e-complete.yml
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ complete_flow.test.bats
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Planet ‚Üí Ingestion ‚Üí ETL ‚Üí Datamarts ‚Üí Profile
‚îÇ   ‚îî‚îÄ‚îÄ cross_repo_integration.test.bats
‚îÇ       ‚îî‚îÄ‚îÄ Verifica flujo completo
‚îî‚îÄ‚îÄ setup/
    ‚îî‚îÄ‚îÄ setup_both_repos.sh
```

**Ventajas:**
- ‚úÖ No acopla los repositorios
- ‚úÖ Puede ejecutarse independientemente
- ‚úÖ Simula el flujo de producci√≥n completo
- ‚úÖ Detecta problemas de integraci√≥n entre repos

**Desventajas:**
- ‚ö†Ô∏è Requiere clonar ambos repos
- ‚ö†Ô∏è Setup m√°s complejo
- ‚ö†Ô∏è M√°s lento de ejecutar

---

### Opci√≥n B: Tests de Contrato (Contract Testing)

Cada repositorio verifica su **contrato** con el otro:

#### En OSM-Notes-profile
```bash
tests/integration/contract_output.test.bats
‚îî‚îÄ‚îÄ Verifica que la salida cumple el contrato:
    ‚úì Tablas notes tienen columnas esperadas
    ‚úì Datos en formato esperado por Analytics
    ‚úì Constraints cumplidos
    ‚úì Schema p√∫blico no cambia sin aviso
```

#### En OSM-Notes-Analytics
```bash
tests/integration/contract_input.test.bats
‚îî‚îÄ‚îÄ Verifica que puede leer el contrato:
    ‚úì Puede leer de notes
    ‚úì Columnas esperadas existen
    ‚úì Tipos de datos correctos
    ‚úì No depende de columnas no documentadas
```

**Ventajas:**
- ‚úÖ Detecta cambios que rompen integraci√≥n
- ‚úÖ Cada repo es independiente
- ‚úÖ Tests r√°pidos y simples
- ‚úÖ F√°cil de mantener

**Desventajas:**
- ‚ö†Ô∏è No prueba el flujo completo
- ‚ö†Ô∏è Requiere mantener documentaci√≥n del contrato

---

## üöÄ Implementaci√≥n Recomendada (Fases)

### Fase 1: Limpiar Workflows Actuales (AHORA) ‚ö°

#### En OSM-Notes-profile

**Actualizar** `.github/workflows/integration-tests.yml`:

```yaml
# ELIMINAR estas l√≠neas (ya no existen estos tests):
- echo "- ‚úÖ ETL_integration.test.bats" >> $GITHUB_STEP_SUMMARY
- echo "- ‚úÖ datamartUsers_integration.test.bats" >> $GITHUB_STEP_SUMMARY
- echo "- ‚úÖ datamartCountries_integration.test.bats" >> $GITHUB_STEP_SUMMARY

# ACTUALIZAR esta l√≠nea:
test_categories=("process-api" "process-planet" "cleanup" "wms")
# Eliminar "etl" de la lista
```

**Actualizar** `tests/run_integration_tests.sh`:

```bash
# ELIMINAR o COMENTAR la funci√≥n:
__run_etl_tests() {
  # Esta funci√≥n ya no aplica - tests movidos a OSM-Notes-Analytics
  log_warn "ETL tests are now in OSM-Notes-Analytics repository"
  return 0
}
```

---

### Fase 2: Crear Tests de Contrato (CORTO PLAZO) üìù

#### En OSM-Notes-profile
```bash
# Crear nuevo test
tests/integration/output_contract.test.bats
```

```bash
#!/usr/bin/env bats

# Contract Test: Verify output format for Analytics
# Author: Andres Gomez (AngocA)
# Version: 2025-10-13

@test "Contract: notes table has expected columns" {
  # Verifica que Analytics puede leer lo que Profile produce
  run psql -d osm_notes -c "\d notes"
  [ "$status" -eq 0 ]
  [[ "$output" == *"note_id"* ]]
  [[ "$output" == *"created_at"* ]]
  [[ "$output" == *"closed_at"* ]]
}

@test "Contract: note_comments table has expected structure" {
  run psql -d osm_notes -c "\d note_comments"
  [ "$status" -eq 0 ]
  [[ "$output" == *"id"* ]]
  [[ "$output" == *"note_id"* ]]
  [[ "$output" == *"event"* ]]
}

@test "Contract: Data types are compatible with Analytics" {
  # Verifica tipos de datos que Analytics espera
  run psql -d osm_notes -c "
    SELECT 
      data_type 
    FROM information_schema.columns 
    WHERE table_name = 'notes' 
    AND column_name = 'created_at';"
  
  [[ "$output" == *"timestamp"* ]]
}
```

#### En OSM-Notes-Analytics
```bash
# Crear nuevo test
tests/integration/input_contract.test.bats
```

```bash
#!/usr/bin/env bats

# Contract Test: Verify input from Ingestion
# Author: Andres Gomez (AngocA)
# Version: 2025-10-13

@test "Contract: Can read from notes table" {
  # Verifica que puede leer lo que Profile produce
  run psql -d osm_notes -c "SELECT COUNT(*) FROM notes LIMIT 1;"
  [ "$status" -eq 0 ]
}

@test "Contract: Required columns exist in notes" {
  # Verifica que las columnas que ETL necesita existen
  run psql -d osm_notes -c "
    SELECT 
      note_id, 
      created_at, 
      closed_at, 
      id_country 
    FROM notes 
    LIMIT 1;"
  
  [ "$status" -eq 0 ]
}

@test "Contract: Can read from note_comments" {
  run psql -d osm_notes -c "
    SELECT 
      id, 
      note_id, 
      event, 
      created_at 
    FROM note_comments 
    LIMIT 1;"
  
  [ "$status" -eq 0 ]
}
```

---

### Fase 3: Documentar Contrato (MEDIANO PLAZO) üìö

Crear documento que especifique el contrato entre repositorios:

**En ambos repos:** `docs/DATA_CONTRACT.md`

```markdown
# Data Contract: Ingestion ‚Üî Analytics

## Schema: public (Managed by OSM-Notes-profile)

### Table: notes
| Column | Type | Nullable | Description | Used by Analytics |
|--------|------|----------|-------------|-------------------|
| note_id | INTEGER | NOT NULL | OSM note ID | ‚úÖ YES (PK in DWH) |
| created_at | TIMESTAMP | NOT NULL | Creation date | ‚úÖ YES (dimension) |
| closed_at | TIMESTAMP | NULL | Closing date | ‚úÖ YES (dimension) |
| lat | DOUBLE | NOT NULL | Latitude | ‚úÖ YES (location) |
| lon | DOUBLE | NOT NULL | Longitude | ‚úÖ YES (location) |
| id_country | INTEGER | NULL | Country FK | ‚úÖ YES (dimension) |
| status | VARCHAR | NOT NULL | open/closed | ‚úÖ YES (filter) |

### Table: note_comments
| Column | Type | Nullable | Description | Used by Analytics |
|--------|------|----------|-------------|-------------------|
| id | SERIAL | NOT NULL | Comment ID | ‚úÖ YES |
| note_id | INTEGER | NOT NULL | Note FK | ‚úÖ YES |
| event | note_event_enum | NOT NULL | Action type | ‚úÖ YES |
| created_at | TIMESTAMP | NOT NULL | Action date | ‚úÖ YES |
| id_user | INTEGER | NULL | User ID | ‚úÖ YES (dimension) |

## Schema: wms (Managed by OSM-Notes-profile)

**Not used by Analytics** ‚ùå

## Schema: dwh (Managed by OSM-Notes-Analytics)

**Not used by Ingestion** ‚ùå

## Breaking Changes Policy

### Major Changes (Require Coordination)
- ‚ùå Removing columns used by Analytics
- ‚ùå Changing column types
- ‚ùå Renaming tables/columns
- ‚ùå Changing enum values

### Minor Changes (Backward Compatible)
- ‚úÖ Adding new columns
- ‚úÖ Adding new tables
- ‚úÖ Adding indexes
- ‚úÖ Changing column order

### Process for Breaking Changes
1. Discuss in GitHub issue (both repos)
2. Update Analytics to handle both old and new format
3. Deploy Analytics first
4. Deploy Ingestion with changes
5. Remove compatibility code from Analytics
```

---

### Fase 4: CI/CD Separado (LARGO PLAZO) üîÑ

#### Workflow para cada repo

**OSM-Notes-profile:**
```yaml
on:
  push:
  pull_request:
  schedule:
    - cron: '0 2 * * *'  # Daily

jobs:
  integration-tests:
    - Run ingestion tests
    - Run WMS tests
    - Run contract output tests ‚ú®
```

**OSM-Notes-Analytics:**
```yaml
on:
  push:
  pull_request:
  schedule:
    - cron: '0 3 * * *'  # Daily (1h after Ingestion)

jobs:
  integration-tests:
    - Run ETL tests
    - Run datamart tests
    - Run contract input tests ‚ú®
```

---

## üìä Matriz de Decisi√≥n

| Tipo de Test | D√≥nde | Frecuencia | Duraci√≥n | Prioridad |
|--------------|-------|------------|----------|-----------|
| **Unit tests** (Profile) | OSM-Notes-profile | Cada push | 5-10 min | üî¥ Alta |
| **Unit tests** (Analytics) | OSM-Notes-Analytics | Cada push | 5-10 min | üî¥ Alta |
| **Integration** (Profile) | OSM-Notes-profile | Cada push | 15-20 min | üü† Media |
| **Integration** (Analytics) | OSM-Notes-Analytics | Cada push | 20-25 min | üü† Media |
| **Contract tests** | Ambos repos | Cada push | 2-3 min | üü° Media-Baja |
| **E2E cross-repo** | Repo separado | Nightly | 45-60 min | üü¢ Baja |

---

## ‚úÖ Recomendaciones Finales

### Para OSM-Notes-profile (AHORA)

1. **‚úÖ Actualizar** `.github/workflows/integration-tests.yml`
   - Eliminar referencias a ETL/datamart
   - Actualizar lista de tests
   
2. **‚úÖ Actualizar** `tests/run_integration_tests.sh`
   - Eliminar funci√≥n `__run_etl_tests`
   - Actualizar help message

3. **üìù Crear** `tests/integration/output_contract.test.bats` (opcional)
   - Verifica que salida cumple contrato
   
4. **üìö Crear** `docs/DATA_CONTRACT.md` (opcional)
   - Documenta esquema p√∫blico

### Para OSM-Notes-Analytics (AHORA)

1. **‚úÖ Verificar** que workflows no referencian Profile
   
2. **üìù Crear** `tests/integration/input_contract.test.bats` (opcional)
   - Verifica que puede leer entrada
   
3. **üìö Crear** `docs/DATA_CONTRACT.md` (opcional)
   - Documenta expectativas de entrada

### Para Futuro (OPCIONAL)

1. **üîÑ Crear** OSM-Notes-E2E-Tests (si es necesario)
   - Solo si hay problemas recurrentes de integraci√≥n
   
2. **üìä Monitoreo** de integraci√≥n en producci√≥n
   - Alertas si Ingestion falla
   - Alertas si Analytics no puede leer datos

---

## üéØ TL;DR - Resumen Ejecutivo

### Estrategia Recomendada: **Tests Independientes por Repositorio**

1. **OSM-Notes-profile** prueba: Ingestion ‚Üí Database ‚úÖ
2. **OSM-Notes-Analytics** prueba: Database ‚Üí Analytics ‚úÖ
3. **Contract tests** (opcional): Verifica compatibilidad ‚úÖ
4. **E2E completo** (opcional): Solo si es realmente necesario ‚ö†Ô∏è

### Acci√≥n Inmediata

```bash
# 1. Actualizar workflow en OSM-Notes-profile
# 2. Eliminar referencias a tests que no existen
# 3. Listo - cada repo prueba su funcionalidad
```

**La clave:** Cada repositorio es **independiente y aut√≥nomo** en sus tests. La integraci√≥n se garantiza mediante el **contrato de base de datos compartida**.

---

**Documento creado:** 2025-10-13  
**Autor:** Andres Gomez (AngocA)  
**Estado:** Propuesta para revisi√≥n

